<!DOCTYPE html>
<html>

<head>
    <link rel="shortcut icon" href="<%= admin_url %>images/favicon_1.ico">
    <title>Aye Finance</title>
    <!--Morris Chart CSS -->
    <link href="<%= admin_url %>stylesheets/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/core.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/components.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/icons.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/responsive.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>plugins/datatables/scroller.bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/core.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/components.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/icons.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/pages.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/responsive.css" rel="stylesheet" type="text/css" />
    
    <link href="<%= admin_url %>plugins/clockpicker/css/bootstrap-clockpicker.min.css" rel="stylesheet">
    <link href="<%= admin_url %>plugins/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <link href="<%= admin_url %>plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet">

    <link href="<%= admin_url %>stylesheets/jquery.loading.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.datatables.net/select/1.2.3/css/select.dataTables.min.css" rel="stylesheet" type="text/css" />
    <link href="<%= admin_url %>stylesheets/custom.css" rel="stylesheet" type="text/css" />
    <!-- HTML5 Shiv and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.javascripts/1.3.0/respond.min.js"></script>
        <![endif]-->
    <script src="<%= admin_url %>javascripts/modernizr.min.js"></script>
</head>

<body class="fixed-left">
    <!-- Begin page -->
    <div id="wrapper">
        <!-- Top Bar Start -->
        <div class="topbar">
            <!-- LOGO -->
            <div class="topbar-left">
                <div class="text-center">
                    <a href="index.html" class="logo"><img src="<%= admin_url %>images/logo_h.png" width="70%"></i></span></a>
                    <!-- Image Logo here -->
                    <!--<a href="index.html" class="logo">-->
                    <!--<i class="icon-c-logo"> <img src="<%= admin_url %>images/logo_sm.png" height="42"/> </i>-->
                    <!--<span><img src="<%= admin_url %>images/logo_light.png" height="20"/></span>-->
                    <!--</a>-->
                </div>
            </div>
            <!-- Button mobile view to collapse sidebar menu -->
            <div class="navbar navbar-default" role="navigation">
                <div class="container">
                    <div class="">
                        <div class="pull-left">
                            <button class="button-menu-mobile open-left waves-effect waves-light">
                                <i class="md md-menu"></i>
                            </button>
                            <span class="clearfix"></span>
                        </div>
                        <!-- <form role="search" class="navbar-left app-search pull-left hidden-xs">
                                <input type="text" placeholder="Search..." class="form-control">
                                <a href=""><i class="fa fa-search"></i></a>
                                </form> -->
                        <ul class="nav navbar-nav navbar-right pull-right">
                            <!--li class="hidden-xs">
                                <a href="#" id="btn-fullscreen" class="waves-effect waves-light"><i class="icon-size-fullscreen"></i></a>
                            </li-->
                            <li class="dropdown top-menu-item-xs">
                                <a href="" class="dropdown-toggle profile waves-effect waves-light" data-toggle="dropdown" aria-expanded="true">Settings</a>
                                <ul class="dropdown-menu">
                                    <li><a href="<%= admin_url %>profile"><i class="ti-user m-r-10 text-custom"></i> Edit Profile</a></li>
                                    <li><a href="<%= admin_url %>change_password"><i class=" ti-key  m-r-10 text-custom"></i> Change Password</a></li>
                                    <li><a href="javascript:void(0)"><i class="ti-lock m-r-10 text-custom"></i> Lock screen</a></li>
                                    <li class="divider"></li>
                                    <li><a href="<%= admin_url %>logout"><i class="ti-power-off m-r-10 text-danger"></i> Logout</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <!--/.nav-collapse -->
                </div>
            </div>
        </div>
        <!-- Top Bar End -->
        <!-- Navigation Bar -->
        <% include ../elements/nevigation.ejs %>
            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="content-page">
                <!-- Start content -->
                <div class="content">
                    <div class="container">
                        <% if (error_flash){ %>
                            <div class="alert alert-danger alert-dismissable">
                                <button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
                                <%= error_flash%>
                            </div>
                            <% } if (success_flash){ %>
                                <div class="alert alert-success alert-dismissable">
                                    <button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
                                    <%= success_flash %>
                                </div>
                                <% } %>
                                    <%- body -%>
                    </div>
                    <!-- container -->
                </div>
                <!-- content -->
                <div class="edit_user"></div>
            </div>
            <footer class="footer text-right">
                © Copyright, 2017
                <div class="pull-right">Powered by Aye Finance</div>
                <hr style="margin:0"> All rights reserved.
                <div class="pull-right"><i class="fa fa-whatsapp  fa-2x "></i> 1800180012</div>
            </footer>
            <div id="mydiv" style="display: none;">
                <img src="<%= admin_url %>images/preloader.gif" class="ajax-loader">
            </div>
            <!-- ============================================================== -->
            <!-- End Right content here -->
            <!-- ============================================================== -->
    </div>
    <!-- END wrapper -->
    <script>
    var resizefunc = [];
    </script>
    <!-- jQuery  -->
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="<%= admin_url %>javascripts/bootstrap.min.js"></script>
    <script src="<%= admin_url %>plugins/bootstrap-table/js/bootstrap-table.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.2.3/js/dataTables.select.min.js"></script>
    <script src="<%= admin_url %>javascripts/detect.js"></script>
    <script src="<%= admin_url %>javascripts/fastclick.js"></script>
    <script src="<%= admin_url %>javascripts/jquery.slimscroll.js"></script>
    <script src="<%= admin_url %>javascripts/jquery.blockUI.js"></script>
    <script src="<%= admin_url %>javascripts/waves.js"></script>
    <script src="<%= admin_url %>javascripts/wow.min.js"></script>
    <script src="<%= admin_url %>plugins/moment/moment.js"></script>


    <script src="<%= admin_url %>plugins/clockpicker/js/bootstrap-clockpicker.min.js"></script>
    <script src="<%= admin_url %>plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
    <script src="<%= admin_url %>plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>

    <script src="<%= admin_url %>javascripts/jquery.loading.js"></script>
    <script src="<%= admin_url %>javascripts/jquery.core.js"></script>
    <script src="<%= admin_url %>javascripts/jquery.app.js"></script>
    <script type="text/javascript" src="<%= admin_url %>plugins/parsleyjs/parsley.min.js"></script>
    <script type="text/javascript">
    $("body").loading();

    $(document).ready(function() {
        $('form').parsley();
        $('.clockpicker').clockpicker({
            afterDone: function(e) {
                $("#notification_time").removeClass('parsley-error');
                $("#parsley-id-27").html('');
            }
        });

        $('#reportrange').daterangepicker({
            format: 'MM/DD/YYYY',
            //startDate: moment().add(1, 'days'),
            startDate: moment().add(),
            endDate: moment(),
            //minDate: moment().add(1, 'days'),
            minDate: moment().add(),
            opens: 'right',
            drops: 'down',
            buttonClasses: ['btn', 'btn-sm'],
            applyClass: 'btn-default',
            cancelClass: 'btn-white',
            separator: ' to ',
            }, function(start, end, label) {
                
                console.log(start.toISOString(), end.toISOString());
                $('#start').val(start.toISOString());
                $('#end').val(end.toISOString());

                var startD = new Date(start);
                var sd = startD.getDate();
                $('#startDate').val(sd);
                $('#startMonth').val(startD.getUTCMonth() + 1);
                $('#startYear').val(startD.getUTCFullYear());

                var endD = new Date(end);
                var ed = endD.getDate();
                $('#endDate').val(ed);
                $('#endMonth').val(endD.getUTCMonth() + 1);
                $('#endYear').val(endD.getUTCFullYear());

                $("#reportrange").removeClass("parsley-error");
                $("#start_end_msg").html("");
                $("#sumbit_sch").removeAttr("disabled");

                if($("#notification_frequency").val() == "m") {
                    //alert(startD.getMonth());
                    //alert(endD.getMonth());
                    //start date and end value must be same
                    //if(sd != ed) 
                    if(startD.getMonth() == endD.getMonth())
                    {
                        $("#reportrange").addClass("parsley-error");
                        //$("#start_end_msg").html("The value of start month date and end month date must be same.");
                        $("#start_end_msg").html("The dates selected must be of different months.");
                        $("#sumbit_sch").attr("disabled", true);
                    }
                }

                $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
            });
            

        var date = new Date();
        //date.setDate(date.getDate()+1);
        date.setDate(date.getDate());
        $('.monthdatepicker').datepicker({
            format: 'mm/dd/yyyy',
            startDate: date,
            autoclose: true
        }).on('changeDate hide', function(){
            if($('.monthdatepicker').val() != ""){

                $("#month_date_msg").html("");
                $(".monthdatepicker").removeClass('parsley-error');
                var str = $('.monthdatepicker').val();
                darr = str.split("/");
                var dobj = new Date(parseInt(darr[2]),parseInt(darr[0])-1,parseInt(darr[1]));
                $('#start').val(dobj.toISOString());
                $('.monthdatepicker').val(moment($('.monthdatepicker').val()).format('MMMM D, YYYY'));
                
            }
        });

        var example = $('#example').DataTable({
            columnDefs: [{
                width: "5%",
                orderable: false,
                className: 'select-checkbox',
                targets: 0
            },
            {
                "targets": [ 2 ],
                "visible": false,
                "searchable": false
            },
            {
                "targets": [ 3 ],
                "visible": false
            }],
            select: {
                style: 'multi',
                selector: 'td:first-child'
            },
            order: [
                [1, 'asc']
            ]
        });
        var DeviceTokens = [];
        var UserIds = [];
        example.on("click", "th.select-checkbox", function() {
            if ($("th.select-checkbox").hasClass("selected")) {
                example.rows().deselect();
                $("th.select-checkbox").removeClass("selected");
                DeviceTokens  = [];
                UserIds  = [];
                $('#deviceTokensData').val(DeviceTokens);
                $('#userIdsData').val(UserIds);
            } else {
                example.rows().select();
                $("th.select-checkbox").addClass("selected");

                DeviceTokens = <%- JSON.stringify(users.map(user => user.pushToken)) %>
                UserIds = <%- JSON.stringify(users.map(user => user._id)) %>
                $('#deviceTokensData').val(DeviceTokens);
                $('#userIdsData').val(UserIds);
            }
        }).on("select deselect", function() {
            ("Some selection or deselection going on")
            if (example.rows({
                    selected: true
                }).count() !== example.rows().count()) {
                $("th.select-checkbox").removeClass("selected");
                $('#deviceTokensData').val(DeviceTokens);
                $('#userIdsData').val(UserIds);
            } else {
                $("th.select-checkbox").addClass("selected");
                DeviceTokens = <%- JSON.stringify(users.map(user => user.pushToken)) %>
                UserIds = <%- JSON.stringify(users.map(user => user._id)) %>
                $('#deviceTokensData').val(DeviceTokens);
                $('#userIdsData').val(UserIds);
            }
        });

        // --------------------------

        example.on( 'select', function ( e, dt, type, indexes ) {
            if ( type === 'row' ) {
                var data = example.rows( indexes ).data()[0];
                DeviceTokens.push(data[2])
                UserIds.push(data[3])
                $('#deviceTokensData').val(DeviceTokens);
                $('#userIdsData').val(UserIds);
                // do something with the ID of the selected items
            }
        });

        example.on( 'deselect', function ( e, dt, type, indexes ) {
            var data = example.rows( indexes ).data()[0]
            DeviceTokens.pop(data[2]);
            UserIds.pop(data[3]);
            $('#deviceTokensData').val(DeviceTokens);
            $('#userIdsData').val(UserIds);
        } );


        function beforeSendNotification(){

        }

        $("#notification_frequency").change(function(e){
            
            $("#monthDate").css("display","none");
            $("#otherDates").css("display","block");
            
            $("#notification_day").removeAttr("disabled");
            $("#notification_day").attr("required",true);
            if($(this).val() == "d" || $(this).val() == "m"){
                $("#notification_day").attr("disabled",true);
                $("#notification_day").removeAttr("required");
            }

            if($(this).val() == "m"){
                $("#monthDate").css("display","block");
                $("#otherDates").css("display","none");
            }
        });

        $("#sumbit_sch").click(function(e){
            var inc = 0;
            $('input,textarea,select').filter('[required]:visible').each(function(e){
                if($(this).val() == ""){
                    inc++;
                }
            });
             
            if(inc == 0){

                //check if dates are selected
                if($("#notification_frequency").val() == "m"){
                    if($("#notification_month_date").val() == ""){
                        $(".monthdatepicker").addClass('parsley-error');
                        $("#month_date_msg").html("Please select a date to send notification.");
                        return false;
                    }
                }
                if($("#notification_frequency").val() == "w" || $("#notification_frequency").val() == "d"){
                    if($('#start').val() == "" || $('#end').val() == ""){
                        $("#reportrange").addClass('parsley-error');
                        $("#start_end_msg").html("Please select a date range to send a notification.");
                        return false;
                    }
                }
                if($("#deviceTokensData").val() == ""){
                    $("#users_required").html("Please select a user from list to send notification");
                    return false;
                }
            }
        });
        
    });

    $(document).ajaxStart(function() {
        $("body").loading();
    });

    $(document).ajaxStop(function() {
        $("body").loading('stop')
    });
    $("body").loading('stop')
    </script>
</body>

</html>